

# 因子构建

## A股SMB和HML因子构建

### 准备底层数据

比较完蛋的是，订阅权限不足以访问Fama-French因子库，所以需要自行构建因子数据，这样做也有几个显而易见的好处：

- 完全透明，不受第三方数据提供商“黑箱”处理的影响；
- 可定制化，根据对大A的特性的认识可以在构建过程进行微调（剔除ST股、上市不足半年的新股等）；
- 可能能帮助苯人理解因子背后的经济逻辑和量化研究方法；

下面使用CSMAR数据构建最核心的SMB（规模）和HML（价值）因子：

| 核心数据表     | 数据库             | 表名                           | 关键字段                                                     |
| -------------- | ------------------ | ------------------------------ | ------------------------------------------------------------ |
| 个股月度回报率 | 个股交易数据库     | 月个股回报率表 (TRD_Mnth)      | 证券代码 (Stkcd), 交易月份 (Trdmnt), 考虑现金红利再投资的月回报率 (Mretwd) |
| 市值数据       | 个股交易数据库     | 月个股交易数据表 (TRD_Msmvttl) | 证券代码 (Stkcd), 交易月份 (Trdmnt), 月末总市值 (Msmvttl)    |
| 账面价值数据   | 财务报表附注数据库 | 上市公司资产负债表 (FS_Combas) | 证券代码 (Stkcd), 报表截止日期 (Accper), 股东权益或所有者权益合计 (Tose) |
| 无风险利率     | 货币市场系列       | 银行同业拆借利率               | 以一年期定期存款利率或者SHIBOR作为月度无风险利率的代理       |

将财务数据（所有者权益，即Book Equity, BE）与市值数据（Market Equity, ME）进行匹配。

- Fama-French方法规定，使用 **上一年末（t-1年12月31日）的BE** 来计算 **当年（t年）7月到下一年（t+1年）6月** 的账面市值比（BE/ME）。
- 例如，要构建2025年7月的投资组合，需要使用2024年12月31日的财务报表中的BE，以及2025年6月末的ME。

通过对上述四个独立的csv文件进行预处理，形成一个统一的面板数据（Panel Data）。

```plaintext
数据集预览:
   stock_code       date       ret        rf  ret_excess            mv            be  bm_ratio
0           1 2005-01-01 -0.080425  0.001978   -0.082403  1.179168e+10  4.684662e+09  0.279948
1           1 2005-02-01  0.069307  0.002117    0.067190  1.260893e+10  4.684662e+09  0.279948
2           1 2005-03-01 -0.195988  0.002507   -0.198495  1.013773e+10  4.684662e+09  0.279948
3           1 2005-04-01  0.190019  0.001750    0.188269  1.206410e+10  4.684662e+09  0.279948
4           1 2005-05-01 -0.030645  0.001905   -0.032550  1.169439e+10  4.684662e+09  0.279948
```

`stock_code`: 证券代码

`date`: 交易月份

`ret`: 月度收益率

`rf`: 无风险月度利率

`ret_excess`: 超额月度收益率

`mv`: 月末总市值

`be`: 用于当期投资组合构建的账面价值（已按FF逻辑对齐）

`bm_ratio`: 账面市值比（已按FF逻辑对齐）

### **构建投资组合**

每年6月末，对A股所有符合条件的股票（剔除金融股、ST股等）进行2*3的二维排序。

1. **规模排序:**
   - 将所有股票按照 **6月末的市值 (ME)** 从小到大排序。
   - 以 **中位数** 为界，将股票分为两组：**小市值组 (Small, S)** 和 **大市值组 (Big, B)**。
2. **账面市值比(B/M)排序:**
   - 计算所有股票的账面市值比 **BE/ME** (Book-to-Market Ratio)。
   - 按照BE/ME从小到大排序，并根据A股市场的常用 breakpoints（例如，按照30%、40%、30%的比例）分为三组：**低B/M组 (Low, L)** 即成长股，**中B/M组 (Medium, M)**，和 **高B/M组 (High, H)** 即价值股。
3. **生成六个交叉组合：**
   - 将规模排序和B/M排序的结果交叉，形成六个投资组合：
     - S/L (小市值/成长)
     - S/M (小市值/中性)
     - S/H (小市值/价值)
     - B/L (大市值/成长)
     - B/M (大市值/中性)
     - B/H (大市值/价值)

### **构建因子收益率序列**

1. **计算组合的月度收益率：**

   对于上述六个组合，计算它们 **从当年7月到下一年6月** 这12个月中，每个月的 **市值加权平均收益率**。用每个组合内所有股票的月度回报率，以它们在上个月末的市值为权重，进行加权平均。

2. **计算SMB和HML因子：**

   - **SMB (Small Minus Big):**

     - $$
       SMB_t=\frac{(S/L_t+S/M_t+S/H_t)}{3}−\frac{(B/L_t+B/M_t+B/H_t)}{3}
       $$

       

     - 三个小市值组合的简单平均收益率减去三个大市值组合的简单平均收益率

   - **HML (High Minus Low):**

     - $$
       HML_t=\frac{S/H_t+B/H_t}{2}-\frac{S/L_t+B/L_t}{2}
       $$

       

     - 两个高B/M（价值）组合的简单平均收益率减去两个低B/M（成长）组合的简单平均收益率

------

**对于其他因子：**

- **动量因子 (UMD):** 排序变量变为过去12个月的累计收益率（通常会跳过最近一个月，即t-12到t-2），排序逻辑类似。
- **盈利因子 (RMW) 和 投资因子 (CMA):** 排序变量分别换成盈利能力指标（如营业利润/账面价值）和投资水平指标（如总资产增长率），排序逻辑与HML类似。

3. **进行投资组合排序：**

​	模拟投资过程，在每年的6月底进行一次投资组合的构建。根据**市值（ME）**和**账面市值比（B/M）**两个维度将股票池切分为6个核心投资组合 (S/L, S/M, S/H, B/L, B/M, B/H)，计算6个组合在未来一年（当年7月至次年6月）的**市值加权**月度收益率。

## 扩展因子构建

从忠于原文设定的角度，我们还要构建出作者使用的整套因子作为基础资产池。好消息是，最复杂的部分似乎已经完成了。构建UMD、RMW和CMA因子的方法论与构建HML**完全相同**，都是“二维排序”，只需要更换排序的“变量”即可。

| 因子                                           | 排序变量         | 所需数据                                                     |
| ---------------------------------------------- | ---------------- | ------------------------------------------------------------ |
| 动量因子 (UMD - Up Minus Down)                 | 历史累计回报率   | `个股月度回报率TRD_Mnth.csv` (已存在)                        |
| 盈利因子 (RMW - Robust Minus Weak)             | 盈利能力指标     | `利润表FS_Comins`和``账面价值数据FS_Combas.csv` (提取“营业利润”和“所有者权益合计”) |
| 投资因子 (CMA - Conservative Minus Aggressive) | 资产增长率       | `账面价值数据FS_Combas.csv` (提取“资产总计”)                 |
| 低风险因子 (Low Risk)                          | 历史波动率或Beta | 非核心因子，可选                                             |

```plain text
年度组合构建进度: 100%|██████████| 20/20 [00:02<00:00,  8.69it/s]

### 因子计算完成！ ###
所有因子收益率序列已保存至all_factors_monthly.csv
因子数据预览:
                 SMB       HML       RMW       CMA       UMD
date                                                        
2007-07-01  0.082943  0.027223 -0.034582 -0.000993  0.076457
2007-08-01 -0.033908 -0.002683 -0.029057  0.000155  0.026529
2007-09-01 -0.023508  0.002902  0.035907  0.012115 -0.055175
2007-10-01 -0.089978 -0.018260  0.108218  0.066493 -0.138924
2007-11-01  0.093055 -0.015396 -0.072457 -0.032253 -0.015702
```

动量因子（UMD）的计算以来的是 `t-12` 到 `t-2` 这11个月的累计收益，需要我们牺牲掉数据序列开始一年多时间的数据来为后续计算做准备。所以我们跳过了2005、2006两年的组合构建以保证数据的完整性。具体实现对应脚本`form_data.dropna(...)`，丢弃任何一个排序变量为空的股票；投资因子（CMA）对计算耗时的要求同理，但是没有UMD对计算要求那般苛刻。

至此，全套因子构建完成。

## 插曲

干完了上面的活才发现，从闲鱼上可以获取到一份文件：`中国五因子STK_MKT_FIVEFACMONTH.xlsx`，这实在是个令人悲伤的好消息。查看表头前五行：

| MarkettypeID     | TradingMonth | Portfolios   | RiskPremium2                 | SMB2                 | HML2                       | RMW2                     | CMA2                     |
| ---------------- | ------------ | ------------ | ---------------------------- | -------------------- | -------------------------- | ------------------------ | ------------------------ |
| 股票市场类型编码 | 交易月份     | 投资组合类型 | 市场风险溢价因子(总市值加权) | 市值因子(总市值加权) | 帐面市值比因子(总市值加权) | 盈利能力因子(总市值加权) | 投资模式因子(总市值加权) |
| P9709            | 1994-01      | 2            | -0.091552                    | 0.081868             | 0.065324                   | -0.00431                 | -0.002309                |
| P9709            | 1994-01      | 1            | -0.091552                    | 0.08746              | 0.068702                   | -0.020783                | 0.004388                 |
| P9714            | 1994-01      | 2            | -0.091552                    | 0.081868             | 0.065324                   | -0.00431                 | -0.002309                |

这一瞬间的感觉就像是——费了九牛二虎之力，从和面、发酵到烘焙，终于做出了一个像样的法式面包。结果一回头，发现街角就有一家百年老店在卖一模一样的——还是米其林产品诶！

冷静一下，我们去做一个有价值的“附加任务”：交叉验证，对比自己计算的因子和这张现成的五因子表。

```plain text
已筛选CSMAR数据: MarkettypeID='P9709', Portfolios=1
合并两组因子数据...
数据合并完成，共有 215 个月的重合数据进行比较。

--- 因子相关系数矩阵 ---
  - SMB 因子相关性: 0.9664
  - HML 因子相关性: 0.8610
  - RMW 因子相关性: 0.7852
  - CMA 因子相关性: 0.8715
```

绘制因子走势对比图：

![comparison_CMA](D:\学校\2025.2第六学期\因子投资\data\factor\validation\comparison_CMA.png)

![comparison_HML](D:\学校\2025.2第六学期\因子投资\data\factor\validation\comparison_HML.png)

![comparison_RMW](D:\学校\2025.2第六学期\因子投资\data\factor\validation\comparison_RMW.png)

![comparison_SMB](D:\学校\2025.2第六学期\因子投资\data\factor\validation\comparison_SMB.png)

总而言之，交叉验证得到的强相关性也标志着本土因子构建工程的质量过关。最重要的一点是，原文的分析包含了**动量因子（UMD）**，而上述五因子表恰恰缺少了它，使用本土数据可以忠实地复现原文献的分析框架。

同样地，自行构建的SMB、HML、RMW、CMA和UMD这五个因子全部出自同一套处理逻辑、同一套股票池筛选规则、同样的断点和加权方式。相比混搭数据源，本土的构建具有方法论一致性和研究过程透明的优势，不亏。